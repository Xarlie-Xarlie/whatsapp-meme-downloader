# Sistema de Download

## üì• Vis√£o Geral da Funcionalidade

O Sistema de Download √© respons√°vel pela aquisi√ß√£o automatizada de v√≠deos do Instagram atrav√©s de web scraping. Utiliza t√©cnicas de automa√ß√£o de browser para extrair links diretos de download e realizar o armazenamento local dos arquivos de m√≠dia.

## üèóÔ∏è Arquitetura e Posicionamento

### Posi√ß√£o na Arquitetura
- **Camada**: L√≥gica de Neg√≥cio/Integra√ß√£o
- **Responsabilidade**: Aquisi√ß√£o de conte√∫do externo
- **Depend√™ncias**: Puppeteer, SaveVid.net, Axios, Sistema de Arquivos

### M√≥dulos Relacionados
- `src/consumer/download_scraper.js` - Scraper principal
- `src/workers/download.js` - Worker de download
- `src/bot/enqueue_job.js` - Interface com sistema de filas
- `src/consumer/consumer.js` - Framework de consumo

## üéØ Prop√≥sito e L√≥gica de Neg√≥cio

### Prop√≥sito Principal
Extrair e baixar v√≠deos do Instagram de forma automatizada, contornando limita√ß√µes da API oficial atrav√©s de web scraping inteligente e resiliente.

### Valor de Neg√≥cio
- ‚úÖ **Automa√ß√£o**: Download sem interven√ß√£o manual
- ‚úÖ **Escalabilidade**: Processamento paralelo de m√∫ltiplos downloads
- ‚úÖ **Resili√™ncia**: Retry autom√°tico em falhas
- ‚úÖ **Flexibilidade**: Suporte a diferentes formatos de URL do Instagram

## üîÑ Fluxo de Trabalho Principal

### Processo de Download Completo

```mermaid
sequenceDiagram
    participant Bot as WhatsApp Bot
    participant Queue as RabbitMQ
    participant Worker as Download Worker  
    participant Scraper as Download Scraper
    participant SaveVid as SaveVid.net
    participant Instagram as Instagram
    participant FS as File System
    
    Bot->>Queue: Enfileira job de download
    Queue->>Worker: Consome job
    Worker->>Scraper: downloadScraper(payload)
    Scraper->>Scraper: Lan√ßa browser Puppeteer
    Scraper->>SaveVid: Navega para savevid.net
    Scraper->>SaveVid: Insere URL Instagram
    Scraper->>SaveVid: Clica em processar
    SaveVid->>Instagram: Extrai v√≠deo
    SaveVid-->>Scraper: Retorna links diretos
    Scraper->>Scraper: Extrai links de download
    
    loop Para cada link
        Scraper->>Instagram: Download via Axios
        Instagram-->>Scraper: Dados bin√°rios do v√≠deo
        Scraper->>FS: Salva arquivo .mp4
    end
    
    Scraper-->>Worker: Lista de arquivos criados
    Worker-->>Queue: Resultado do processamento
    Queue-->>Bot: Notifica√ß√£o de conclus√£o
```

### Fluxo Detalhado de Scraping

```mermaid
flowchart TD
    A[Receber URL Instagram] --> B[Validar formato URL]
    B -->|Inv√°lida| C[Erro: URL n√£o suportada]
    B -->|V√°lida| D[Lan√ßar browser Puppeteer]
    D --> E[Navegar para SaveVid.net]
    E --> F[Inserir URL no campo input]
    F --> G[Clicar bot√£o processar]
    G --> H[Aguardar resultados]
    H --> I{Links encontrados?}
    I -->|N√£o| J[Erro: Sem links]
    I -->|Sim| K[Extrair links .abutton]
    K --> L[Filtrar por 'Download Video']
    L --> M[Para cada link v√°lido]
    M --> N[Download via Axios]
    N --> O[Gerar nome √∫nico]
    O --> P[Salvar arquivo]
    P --> Q{Mais links?}
    Q -->|Sim| M
    Q -->|N√£o| R[Retornar lista arquivos]
    
    style A fill:#e1f5fe
    style R fill:#e8f5e8
    style C fill:#ffebee
    style J fill:#ffebee
```

## üìã Componentes T√©cnicos Detalhados

### **Puppeteer Configuration**
```javascript
const browser = await puppeteer.launch({
  browser: 'firefox',
  headless: true,
  args: ['--no-sandbox', '--disable-setuid-sandbox'],
  executablePath: '/usr/bin/firefox'
});
```

### **Web Scraping Steps**
1. **Navega√ß√£o**: `page.goto('https://savevid.net/en')`
2. **Input**: `page.type('input', link)`
3. **Processamento**: `page.click('.btn-default')`
4. **Extra√ß√£o**: `page.$$eval('.abutton', extractFunction)`

### **Download Implementation**
```javascript
async function downloadFile(href) {
  return axios.get(href, {
    responseType: 'arraybuffer'  // Para arquivos bin√°rios
  });
}

async function fileWrite(link, index, data) {
  const filePath = createFileName(link, index);
  await fs.writeFile(filePath, data);
}
```

## üèóÔ∏è Modelo de Dom√≠nio da Funcionalidade

### **Entidades Principais**

#### üì• **Job de Download (DownloadJob)**
- **Propriedades**:
  - `link`: URL original do Instagram
  - `retryCount`: N√∫mero de tentativas
  - `from`: ID do solicitante
  - `noreply`: Flag para envio autom√°tico

#### üé¨ **V√≠deo Instagram (InstagramVideo)**
- **Propriedades**:
  - `originalUrl`: URL original
  - `instagramId`: ID extra√≠do da URL
  - `downloadUrls`: URLs diretas extra√≠das
  - `filePaths`: Caminhos dos arquivos salvos
  - `downloadedAt`: Timestamp do download

#### üîó **Link de Download (DownloadLink)**
- **Propriedades**:
  - `url`: URL direta do v√≠deo
  - `quality`: Qualidade do v√≠deo (se dispon√≠vel)
  - `fileSize`: Tamanho estimado

### **Objetos de Valor**

#### üìÇ **Nome de Arquivo (FileName)**
```javascript
function createFileName(link, index) {
  if (link.includes('/p/')) {
    return `./videos/${link.split('/p/')[1].replace(/\/.*/, '')}${index}.mp4`;
  } else if (link.includes('/reel/')) {
    return `./videos/${link.split('/reel/')[1].replace(/\/.*/, '')}${index}.mp4`;
  } else if (link.includes('/reels/')) {
    return `./videos/${link.split('/reels/')[1].replace(/\/.*/, '')}${index}.mp4`;
  }
}
```

### **Regras de Neg√≥cio Espec√≠ficas**

#### **RN-DL001**: Valida√ß√£o de URLs
| Padr√£o URL | A√ß√£o | Exemplo |
|------------|------|---------|
| `/p/{id}` | Aceitar como post | `instagram.com/p/ABC123/` |
| `/reel/{id}` | Aceitar como reel | `instagram.com/reel/XYZ789/` |
| `/reels/{id}` | Aceitar como reel | `instagram.com/reels/XYZ789/` |
| Outros | Rejeitar | Qualquer outro formato |

#### **RN-DL002**: Nomenclatura de Arquivos
- **Padr√£o**: `{instagram_id}{index}.mp4`
- **Index**: Sequencial a partir de 0
- **Diret√≥rio**: `./videos/`
- **Exemplo**: `ABC123.mp4`, `ABC1231.mp4`

#### **RN-DL003**: Gest√£o de Duplicatas
- **Verifica√ß√£o**: Verificar exist√™ncia antes de salvar
- **Sobrescrita**: Permitida (arquivo ser√° substitu√≠do)
- **Conflitos**: √öltimo download prevalece

## üîß Depend√™ncias e Integra√ß√µes

### **SaveVid.net Integration**
```javascript
const url = 'https://savevid.net/en';

// Processo de extra√ß√£o
await page.goto(url);
await page.type('input', link);
await page.click('.btn-default');
await page.waitForSelector('.abutton');

// Extra√ß√£o de links
const links = await page.$$eval('.abutton', (aTags) => {
  return aTags
    .filter((a) => a.title === 'Download Video')
    .map((a) => a.href);
});
```

### **Sistema de Filas**
```javascript
// Worker de download
import consumer from '../consumer/consumer.js';
import downloadScraper from '../consumer/download_scraper.js';

consumer('download_queue', downloadScraper, eventCallback);
```

### **Gest√£o de Falhas**
```javascript
// Dead Letter Queue para retry
import dlqConsumer from '../consumer/dlq_consumer.js';

dlqConsumer('download_queue_dlq', eventCallback);
```

## ‚ö†Ô∏è Casos Extremos e Tratamento de Erros

### **Cen√°rios de Falha**

#### 1. **SaveVid.net Indispon√≠vel**
- **Detec√ß√£o**: Timeout ou erro de navega√ß√£o
- **A√ß√£o**: Enviar para DLQ para retry
- **Fallback**: Tentativas com delay exponencial

#### 2. **URL Instagram Inv√°lida**
- **Detec√ß√£o**: SaveVid.net n√£o retorna links
- **A√ß√£o**: Marcar como falha definitiva
- **Log**: Registrar URL problem√°tica

#### 3. **Falha de Download**
- **Detec√ß√£o**: Erro no Axios ou arquivo corrompido
- **A√ß√£o**: Retry apenas este arquivo
- **Limite**: M√°ximo 5 tentativas por link

#### 4. **Espa√ßo em Disco Insuficiente**
- **Detec√ß√£o**: Erro de escrita no filesystem
- **A√ß√£o**: Interromper downloads e alertar
- **Recupera√ß√£o**: Limpeza autom√°tica de tempor√°rios

### **Limita√ß√µes e Contornos**

#### **Depend√™ncia Externa**
- **Problema**: SaveVid.net pode ficar indispon√≠vel
- **Contorno**: Sistema de retry com backoff
- **Monitoramento**: Alertas de falhas consecutivas
- **Futuro**: M√∫ltiplos providers de scraping

#### **Rate Limiting**
- **Problema**: Instagram/SaveVid podem limitar requests
- **Contorno**: Delays entre requests
- **Implementa√ß√£o**: Pool de browsers com rota√ß√£o

#### **Mudan√ßas na Interface**
- **Problema**: SaveVid.net pode alterar seletores
- **Contorno**: Seletores gen√©ricos quando poss√≠vel
- **Manuten√ß√£o**: Monitoramento de falhas de scraping

## üé® Fluxo de Integra√ß√£o com Outros M√≥dulos

```mermaid
graph TD
    subgraph "Sistema de Download"
        A[Download Worker]
        B[Download Scraper]
        C[Puppeteer Browser]
        D[Axios Downloader]
    end
    
    subgraph "Integra√ß√µes Externas"
        E[SaveVid.net]
        F[Instagram]
    end
    
    subgraph "Sistema de Filas"
        G[Download Queue]
        H[Download DLQ]
    end
    
    subgraph "Sistema de Arquivos"
        I[Videos Directory]
        J[File System]
    end
    
    subgraph "Processamento Posterior"
        K[Cutter Queue]
        L[Video Segmenter]
    end
    
    G --> A
    A --> B
    B --> C
    C --> E
    E --> F
    B --> D
    D --> J
    J --> I
    
    A -.->|Falha| H
    H -.->|Retry| G
    
    A -->|Sucesso| K
    K --> L
    
    style A fill:#e1f5fe
    style B fill:#e8f5e8
    style E fill:#fff3e0
    style F fill:#fce4ec
```

## üìä M√©tricas e Monitoramento

### **M√©tricas de Performance**
```javascript
// Logs implementados
console.log(`File downloaded and saved to ${filePath}`);
console.error(`Error getting video duration: ${error.message}`);
```

### **KPIs do Sistema**
- **Taxa de Sucesso**: Downloads conclu√≠dos / Downloads tentados
- **Tempo M√©dio**: Dura√ß√£o desde enfileiramento at√© conclus√£o
- **Taxa de Retry**: Jobs que precisaram de nova tentativa
- **Disponibilidade Externa**: Uptime do SaveVid.net

### **Alertas Operacionais**
- ‚ö†Ô∏è Taxa de falha > 10%
- ‚ö†Ô∏è Tempo m√©dio > 2 minutos
- ‚ö†Ô∏è SaveVid.net indispon√≠vel
- ‚ö†Ô∏è Espa√ßo em disco < 1GB

## üîÆ Casos de Uso Avan√ßados

### **Download em Lote**
```javascript
// M√∫ltiplas URLs em um comando
const links = message.body.split(' ').slice(1);
links.forEach((link) => {
  enqueueJob('download_queue', {
    link: link,
    retryCount: 0,
    from: message.from,
    noreply: noreply
  });
});
```

### **Download de Arquivo de Texto**
```javascript
// Suporte a upload de arquivo com URLs
if (message.hasMedia && message.body.startsWith('!download')) {
  const media = await message.downloadMedia();
  const decodedText = atob(media.data);
  const lines = decodedText.split('\n');
  
  lines.forEach((line) => {
    enqueueJob('download_queue', { link: line, ... });
  });
}
```

## üöÄ Melhorias Futuras

### **Curto Prazo**
- üîÑ Pool de browsers para paraleliza√ß√£o
- üìä M√©tricas detalhadas de performance
- üîß Configura√ß√£o de timeout por tipo de conte√∫do

### **M√©dio Prazo**
- üåê Suporte a m√∫ltiplos providers de scraping
- ü§ñ Detec√ß√£o autom√°tica de qualidade de v√≠deo
- üì± Suporte a outros tipos de m√≠dia (imagens, stories)

### **Longo Prazo**
- üß† IA para otimiza√ß√£o de rota de download
- ‚òÅÔ∏è Integra√ß√£o com CDNs para cache
- üîí Bypass inteligente de anti-bot measures